language: C
sudo: required
cache: ccache

before_install:
  - echo -e "machine github.com\n  login $GITHUB_TOKEN" > ~/.netrc
  - ccache -M 0
  - ccache -F 0
  - sudo fallocate -l 8G /swapfile
  - sudo chmod 600 /swapfile
  - sudo mkswap /swapfile
  - sudo swapon /swapfile
  - export GITHUB_TOKEN="$GITHUB_TOKEN"
  - export release_repo="danascape/kernel-CI"
  - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')}
  - sudo apt-get update
  - sudo apt-get install -y zstd adb autoconf automake axel bc bison build-essential clang cmake expat fastboot flex g++ g++-multilib gawk gcc gcc-multilib git-core gnupg gperf htop imagemagick lib32ncurses5-dev lib32z1-dev libtinfo5 libc6-dev libcap-dev libexpat1-dev libgmp-dev liblz4-* liblzma* libmpc-dev libmpfr-dev libncurses5-dev libsdl1.2-dev libssl-dev libtool libxml2 libxml2-utils lzma* lzop maven ncftp ncurses-dev patch patchelf pkg-config pngcrush pngquant python python-all-dev re2c schedtool squashfs-tools subversion texinfo unzip w3m xsltproc zip zlib1g-dev lzip p7zip-full binutils-aarch64-linux-gnu munge > /dev/null 2>&1
  - echo "deb http://archive.ubuntu.com/ubuntu disco main" >> /etc/apt/sources.list
  - echo "deb http://security.ubuntu.com/ubuntu disco-security main universe" >> /etc/apt/sources.list
  - sudo apt-get install libc6 > /dev/null 2>&1

before_script:
  - cd $HOME && PATH=~/bin:$PATH
  - curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
  - chmod a+x ~/bin/repo
script:
  - cd $HOME && git clone https://github.com/iamsaalim/kernel_asus_X00P --depth 1 kernel
  - cd $HOME/kernel
  - git clone https://github.com/stormbreaker-project/aarch64-linux-android-4.9 --depth 1 gcc
  - git clone https://github.com/stormbreaker-project/arm-linux-androideabi-4.9 --depth 1 gcc32
  - git clone --depth=1 https://github.com/Haseo97/Clang-10.0.0 clang
  - export PATH="$HOME/kernel/clang/bin:$HOME/kernel/gcc/bin:$HOME/kernel/gcc32/bin:$PATH"
  - export KBUILD_COMPILER_STRING="$("$HOME/kernel/clang/bin/clang --version | head -n 1 | perl -pe 's/\((?:http|git).*?\)//gs' | sed -e 's/  */ /g' -e 's/[[:space:]]*$//' -e 's/^.*clang/clang/')"
  - export ARCH=arm64 SUBARCH=arm64
  - export KBUILD_BUILD_USER=danascape
  - export KBUILD_BUILD_HOST=travisCI
  - make O=out X00P_defconfig ARCH=arm64
  - make -j$(nproc --all) O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- CROSS_COMPILE_ARM32=arm-linux-androideabi-
  - git clone -b X00P https://github.com/stormbreaker-project/AnyKernel3
  - cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
  - cd AnyKernel3
  - make clean && make normal
before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "iamsaalim"
  - git config --local user.email "saalimquadri1@gmail.com"
  - git tag $TRAVIS_TAG
deploy:
  provider: releases
  api_key: "$GITHUB_TOKEN"
  file: $HOME/kernel/out/arch/arm64/boot/Image.gz-dtb
  file: $HOME/kernel/out/arch/arm64/boot/dts/qcom/msm8937-pmi8940-X00P.dtb
  file: $HOME/kernel/AnyKernel3/Stormbreaker*.zip
  skip_cleanup: true
  on:
    tags: true
    repo: stormbreaker-project/kernel-CI
    branch: master
